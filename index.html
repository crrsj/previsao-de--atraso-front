<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightOnTime - Previsão de Atraso de Voo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 700px;
            margin-top: 50px;
            margin-bottom: 50px;
        }
        .header-title {
            color: #0d6efd;
            font-weight: 300;
        }
    </style>
</head>
<body>

    <div class="container bg-white p-4 rounded shadow-lg">
        <h2 class="text-center header-title mb-4">✈️ FlightOnTime: Previsão de Pontualidade</h2>
        <p class="text-center text-muted">Consulte a probabilidade de atraso do seu voo com base nos dados logísticos.</p>

        <form id="predictionForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="airline" class="form-label">Companhia Aérea (IATA)</label>
                    <input type="text" class="form-control" id="airline" placeholder="Ex: GOL, AZU, LAT" maxlength="3" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="distancia_km" class="form-label">Distância em KM</label>
                    <input type="number" class="form-control" id="distancia_km" placeholder="Ex: 350" required min="10">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="origin" class="form-label">Aeroporto de Origem (IATA)</label>
                    <input type="text" class="form-control" id="origin" placeholder="Ex: GRU" maxlength="3" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="destination" class="form-label">Aeroporto de Destino (IATA)</label>
                    <input type="text" class="form-control" id="destination" placeholder="Ex: CGH" maxlength="3" required>
                </div>
            </div>

            <div class="mb-4">
                <label for="data_partida" class="form-label">Data e Hora de Partida</label>
                <input type="datetime-local" class="form-control" id="data_partida" required>
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                    Consultar Previsão
                </button>
            </div>
        </form>

        <div id="resultCard" class="card mt-5 d-none">
            <div class="card-header bg-light">
                Resultado da Análise de Risco
            </div>
            <div class="card-body text-center">
                <h3 class="card-title mb-3">Status Estimado: <span id="resultStatus" class="fw-bold"></span></h3>
                <p class="card-text lead">
                    <span id="resultProbability">Probabilidade: --%</span>
                </p>
                <p class="text-muted small" id="resultMessage">Previsão calculada com base em análise de risco de ML.</p>
            </div>
        </div>
        
        <div id="errorAlert" class="alert alert-danger mt-4 d-none" role="alert">
            
        </div>

    </div>

    <script>
        // O Backend Java está na porta 8080
        const API_URL = 'http://localhost:8080/predict'; 

        document.getElementById('predictionForm').addEventListener('submit', function(event) {
            event.preventDefault();

            // Esconder resultados e alertas anteriores
            document.getElementById('resultCard').classList.add('d-none');
            document.getElementById('errorAlert').classList.add('d-none');
            document.getElementById('errorAlert').textContent = '';

            // 1. Coletar e formatar dados do formulário
            
            // O input datetime-local fornece: YYYY-MM-DDTHH:MM
            const rawDateTime = document.getElementById('data_partida').value;
            // Para o formato ISO 8601 completo (YYY-MM-DDTHH:MM:SS), adicionamos :00 no final
            const formattedDateTime = rawDateTime + ':00'; 

            const requestData = {
                // Os nomes das chaves DEVEM corresponder ao FlightRequest.java / Python
                "companhia": document.getElementById('airline').value.toUpperCase(),
                "origem": document.getElementById('origin').value.toUpperCase(),
                "destino": document.getElementById('destination').value.toUpperCase(),
                "data_partida": formattedDateTime,
                "distancia_km": parseInt(document.getElementById('distancia_km').value)
            };
            
            // 2. Fazer a requisição POST para a API (Backend Java)
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                // 2.1. Tratar Status HTTP de Erro (4xx e 5xx)
                if (!response.ok) {
                    // Tenta ler o corpo JSON do erro
                    return response.json().then(err => { 
                        // Exemplo: se o erro for do Java (ex: validação), ele terá um campo 'previsao'
                        throw new Error(err.previsao || `Erro HTTP: ${response.status}`); 
                    }).catch(() => {
                        // Se não for JSON (ex: erro de conexão do servidor), lança um erro genérico
                        throw new Error(`Erro de Servidor Inesperado: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // 3. Exibir o resultado
                const resultStatusElement = document.getElementById('resultStatus');
                const probDecimal = data.probabilidade;

                // Formata a probabilidade de decimal (0.78) para percentual (78.00%)
                document.getElementById('resultProbability').textContent = `Probabilidade: ${(probDecimal * 100).toFixed(2)}%`;
                
                // data.previsao é a string "Pontual" ou "Atrasado" vinda do Python
                const status = data.previsao.toUpperCase();
                resultStatusElement.textContent = status; 
                
                // Mudar a cor do status baseado no resultado
                resultStatusElement.classList.remove('text-success', 'text-danger');
                if (status === 'ATRASADO') {
                    resultStatusElement.classList.add('text-danger');
                } else {
                    resultStatusElement.classList.add('text-success');
                }

                document.getElementById('resultCard').classList.remove('d-none');
            })
            .catch(error => {
                // Trata erros (rede, validação, servidor)
                console.error('Erro na requisição:', error);
                document.getElementById('errorAlert').textContent = `Falha: ${error.message}. Verifique se a porta 8080 (Java) e 5000 (Python) estão ativas.`;
                document.getElementById('errorAlert').classList.remove('d-none');
            });
        });
    </script>

</body>
</html>